<!-- 
  This file must be hosted on a secure (https://) server to access the microphone.
  It will NOT work in a SquareSpace "Code Block".
  It WILL work if hosted on a service like GitHub Pages and added
  to SquareSpace using an "Embed" block.
-->

<!-- 
  NO EXTERNAL LIBRARIES ARE USED.
  The pitch detection algorithm is now built-in below.
-->

<!-- 
  WRAPPER DIV 
  All quiz content now lives inside this wrapper.
-->
<div id="intrvl-quiz-wrapper" style="width: 100%; margin: 0 auto; max-width: 500px; text-align: center;">
  
  <!-- 
    SCOPED STYLES
    All styles are self-contained and scoped to this wrapper.
    No font sizes are defined, so they will be inherited from your site.
  -->
  <style>
    /* --- Base & Font Inheritance --- */
    #intrvl-quiz-wrapper {
      font-family: inherit;
      color: inherit;
      text-align: center;
      box-sizing: border-box;
    }
    #intrvl-quiz-wrapper *,
    #intrvl-quiz-wrapper *::before,
    #intrvl-quiz-wrapper *::after {
      box-sizing: border-box;
      font: inherit;
      color: inherit;
      margin: 0;
      padding: 0;
    }
    
    /* --- Layout --- */
    #intrvl-quiz-wrapper .screen {
      background-color: #FAFAFA; /* light */
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: opacity 0.3s ease-in-out, visibility 0.3s;
      min-height: 400px;
    }
    #intrvl-quiz-wrapper .screen.hidden {
      opacity: 0;
      visibility: hidden;
      display: none;
    }
    #intrvl-quiz-wrapper .grid-cols-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    #intrvl-quiz-wrapper .grid-cols-1 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    #intrvl-quiz-wrapper .flex-col {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* --- Spacing --- */
    #intrvl-quiz-wrapper .mb-2 { margin-bottom: 8px; }
    #intrvl-quiz-wrapper .mb-4 { margin-bottom: 16px; }
    #intrvl-quiz-wrapper .mb-6 { margin-bottom: 24px; }
    #intrvl-quiz-wrapper .mt-1 { margin-top: 4px; }
    #intrvl-quiz-wrapper .mt-4 { margin-top: 16px; }
    #intrvl-quiz-wrapper .mt-8 { margin-top: 32px; }
    #intrvl-quiz-wrapper .my-4 { margin-top: 16px; margin-bottom: 16px; }
    #intrvl-quiz-wrapper .my-8 { margin-top: 32px; margin-bottom: 32px; }
    
    /* --- Elements --- */
    #intrvl-quiz-wrapper h3 { color: #1C1C1C; }
    #intrvl-quiz-wrapper h4 { color: #D9A5B3; }
    #intrvl-quiz-wrapper .text-gray-500 { color: #6B7280; }
    #intrvl-quiz-wrapper .text-primary { color: #D9A5B3; }
    
    #intrvl-quiz-wrapper .btn {
      width: 100%;
      background-color: #D9A5B3; /* primary */
      color: #1C1C1C; /* dark */
      padding: 12px 24px;
      margin: 4px 0;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
    }
    #intrvl-quiz-wrapper .btn:hover { background-color: #C18F9D; }
    #intrvl-quiz-wrapper .btn:active { transform: scale(0.98); }
    #intrvl-quiz-wrapper .btn:disabled { background-color: #cccccc; cursor: not-allowed; }
    #intrvl-quiz-wrapper .btn.secondary { background-color: #B7A7C9; }
    #intrvl-quiz-wrapper .btn.secondary:hover { background-color: #9B8198; }
    #intrvl-quiz-wrapper .btn.accent { background-color: #C1A45F; }
    #intrvl-quiz-wrapper .btn.accent:hover { background-color: #A58441; }

    #intrvl-quiz-wrapper #feedback {
      min-height: 1.5em;
      margin: 16px 0;
    }
    #intrvl-quiz-wrapper #feedback.correct { color: #A9B9A2; }
    #intrvl-quiz-wrapper #feedback.incorrect { color: #D9A074; }

    /* --- New Quiz Screen Styles --- */
    #intrvl-quiz-wrapper #question-image {
      width: 100%;
      max-width: 280px;
      margin: 20px auto;
      height: 150px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      display: block;
      object-fit: contain;
    }
    #intrvl-quiz-wrapper #tuner-display {
      margin-top: 20px;
      padding: 16px;
      background-color: #fff;
      border-radius: 8px;
    }
    #intrvl-quiz-wrapper #tuner-status {
      min-height: 1.5em;
    }
    #intrvl-quiz-wrapper #heard-note {
      min-height: 1.5em;
      color: #D9A5B3; /* primary */
    }
    #intrvl-quiz-wrapper .text-red { color: #D9A074; }

  </style>

  <!-- 
    HTML Screens
    - Menu: Select Clef
    - Permission: Ask for microphone
    - Quiz: Show note, listen for pitch
    - End: Show score
  -->
  <div class="w-full-and-max-w-md-replacement">

    <!-- Menu Screen -->
    <div id="menu-screen" class="screen">
      <h3 class="mb-6">Select Quiz</h3>
      <div class="grid-cols-2 mb-4">
        <div class="menu-item">
          <button class="btn" data-type="treble">Treble Clef</button>
          <p class="text-gray-500 mt-1">High Score<br>0</p>
        </div>
        <div class="menu-item">
          <button class="btn" data-type="bass">Bass Clef</button>
          <p class="text-gray-500 mt-1">High Score<br>0</p>
        </div>
        <div class="menu-item">
          <button class="btn" data-type="tenor">Tenor Clef</button>
          <p class="text-gray-500 mt-1">High Score<br>0</p>
        </div>
        <div class="menu-item">
          <button class="btn" data-type="alto">Alto Clef</button>
          <p class="text-gray-500 mt-1">High Score<br>0</p>
        </div>
      </div>
      <div class="grid-cols-1 mb-4">
        <div class="menu-item">
          <button class="btn" data-type="treblebass">Treble &amp; Bass</button>
          <p class="text-gray-500 mt-1">High Score<br>0</p>
        </div>
        <div class="menu-item">
          <button class="btn" data-type="all">All Clefs</button>
          <p class="text-gray-500 mt-1">High Score<br>0</p>
        </div>
      </div>
       <p class="text-gray-500 mt-4">High scores are saved per-clef</p>
    </div>

    <!-- Permission Screen -->
    <div id="permission-screen" class="screen hidden">
      <h3 class="mb-4">Microphone Access</h3>
      <p class="text-gray-500 mb-6">This quiz needs to use your microphone to hear the notes you play.</p>
      <div class="flex-col">
        <button id="start-mic-btn" class="btn accent">Start Listening</button>
        <button id="permission-cancel-btn" class="btn secondary">Cancel</button>
      </div>
      <p id="mic-error" class="text-red mt-4"></p>
    </div>

    <!-- Quiz Screen -->
    <div id="quiz-screen" class="screen hidden">
      <h3 id="quiz-title" class="mb-2"></h3>
      
      <img id="question-image" src="" alt="Note on stave" />
      
      <div id="tuner-display">
        <p id="tuner-status">Listening...</p>
        <h4 id="heard-note" class="text-primary">Heard: ---</h4>
      </div>

      <p id="feedback" class="my-4"></p>
      
      <p id="score-display" class="my-4">Score: 0</p>
      
      <button id="goback-button-quiz" class="btn secondary mt-8">Go Back</button>
      <p id="game-high" class="text-gray-500 mt-4">High Score: 0</p>
    </div>

    <!-- End Screen -->
    <div id="end-screen" class="screen hidden">
      <h3 id="end-title" class="mb-4">Quiz Complete!</h3>
      <p id="final-score" class="mb-4"></p>
      <p id="end-high" class="text-gray-500 mb-6">High Score: 0</p>
      <div class="flex-col">
        <button class="btn" id="retry-button">Try Again</button>
        <button class="btn secondary" id="restart-button">Select Another Quiz</button>
      </div>
    </div>

  </div> <!-- End of wrapper -->

  <script>
    // --- Constants ---
    const DATA_URL = "https://raw.githubusercontent.com/piapaul/music-theory-images/main/standard-notes.json";
    const IMAGE_BASE_URL = "https://piapaul.github.io/music-theory-images/single";
    
    // Note filters (same as before)
    const typeFilters = {
      treble: ["treble"],
      bass: ["bass"],
      treblebass: ["treble", "bass"],
      tenor: ["tenor"],
      alto: ["alto"],
      all: ["treble", "bass", "tenor", "alto", "treble8vb"],
    };
    const typeNames = {
      treble: "Treble Clef",
      bass: "Bass Clef",
      treblebass: "Treble & Bass",
      tenor: "Tenor Clef",
      alto: "Alto Clef",
      all: "All Clefs",
    };

    // --- State Variables ---
    let allNotesData, quizData, currentType, score, usedQuestions;
    let highScores = {};
    let currentQuestion = {}; // { 'note-name': 'C4', clef: 'treble', ... }
    let isListening = false;
    let audioContext, analyser, mediaStreamSource;
    let audioBuffer = null;
    let rafID = null; // requestAnimationFrame ID
    
    // --- DOM Elements Cache ---
    let DOM = {};

    // --- NEW PITCH DETECTION ALGORITHM (Replaces Pitchy) ---
    // This code is now part of the main script, so it cannot fail to load.

    const noteStrings = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    
    /**
     * Converts a frequency in Hz to a MIDI note number.
     * @param {number} frequency - Frequency in Hz.
     * @returns {number} MIDI note number.
     */
    function noteFromPitch(frequency) {
      const noteNum = 12 * (Math.log(frequency / 440) / Math.log(2));
      return Math.round(noteNum) + 69;
    }

    /**
     * Performs autocorrelation on an audio buffer to find the fundamental frequency.
     * @param {Float32Array} buf - The audio buffer (time-domain data).
     * @param {number} sampleRate - The sample rate of the AudioContext.
     * @returns {number} The detected frequency in Hz, or -1 if no clear pitch is found.
     */
    function autoCorrelate(buf, sampleRate) {
      // YIN algorithm implementation
      const SIZE = buf.length;
      let rms = 0;

      for (let i = 0; i < SIZE; i++) {
        const val = buf[i];
        rms += val * val;
      }
      rms = Math.sqrt(rms / SIZE);
      if (rms < 0.01) { // Not enough signal
        return -1;
      }

      let r1 = 0, r2 = SIZE - 1;
      const thres = 0.2;
      for (let i = 0; i < SIZE / 2; i++) {
        if (Math.abs(buf[i]) < thres) { r1 = i; break; }
      }
      for (let i = 1; i < SIZE / 2; i++) {
        if (Math.abs(buf[SIZE - i]) < thres) { r2 = SIZE - i; break; }
      }

      const buf2 = buf.slice(r1, r2);
      const SIZE2 = buf2.length;
      
      const c = new Array(SIZE2).fill(0);
      for (let i = 0; i < SIZE2; i++) {
        for (let j = 0; j < SIZE2 - i; j++) {
          c[i] = c[i] + buf2[j] * buf2[j + i];
        }
      }

      let d = 0;
      while (c[d] > c[d + 1]) {
        d++;
      }
      
      let maxval = -1, maxpos = -1;
      for (let i = d; i < SIZE2; i++) {
        if (c[i] > maxval) {
          maxval = c[i];
          maxpos = i;
        }
      }
      
      let T0 = maxpos;
      
      // Parabolic interpolation for greater accuracy
      const x1 = c[T0 - 1], x2 = c[T0], x3 = c[T0 + 1];
      const a = (x1 + x3 - 2 * x2) / 2;
      const b = (x3 - x1) / 2;
      if (a) {
        T0 = T0 - b / (2 * a);
      }

      if (T0 === 0) return -1;
      
      return sampleRate / T0;
    }
    
    // --- END of new pitch detection code ---


    
    function cacheDOMElements() {
      DOM.wrapper = document.getElementById("intrvl-quiz-wrapper");
      DOM.menu = document.getElementById("menu-screen");
      DOM.permission = document.getElementById("permission-screen");
      DOM.quiz = document.getElementById("quiz-screen");
      DOM.end = document.getElementById("end-screen");
      
      DOM.startMicBtn = document.getElementById("start-mic-btn");
      DOM.permissionCancelBtn = document.getElementById("permission-cancel-btn");
      DOM.micError = document.getElementById("mic-error");

      DOM.quizTitle = document.getElementById("quiz-title");
      DOM.questionImage = document.getElementById("question-image");
      DOM.tunerStatus = document.getElementById("tuner-status");
      DOM.heardNote = document.getElementById("heard-note");
      DOM.feedback = document.getElementById("feedback");
      DOM.scoreDisplay = document.getElementById("score-display");
      DOM.gameHigh = document.getElementById("game-high");
      
      DOM.endTitle = document.getElementById("end-title");
      DOM.finalScore = document.getElementById("final-score");
      DOM.endHigh = document.getElementById("end-high");
      
      DOM.retryBtn = document.getElementById("retry-button");
      DOM.restartBtn = document.getElementById("restart-button");
      DOM.goBackQuizBtn = document.getElementById("goback-button-quiz");
    }

    // --- Screen Navigation ---
    function showScreen(screen) {
      if (!DOM.menu) return; 
      [DOM.menu, DOM.permission, DOM.quiz, DOM.end].forEach(s => {
        if(s) s.classList.add('hidden');
      });
      setTimeout(() => {
        if(screen) screen.classList.remove('hidden');
      }, 10);
    }

    // --- Game Logic ---
    
    /**
     * This function now just starts the app.
     * No library check is needed.
     */
    function onDomReady() {
      try {
        cacheDOMElements(); 
        console.log("DOM cached. Initializing app.");
        runInit();
      } catch (e) {
         console.error("Error during initialization:", e);
         if (DOM.wrapper) {
            DOM.wrapper.innerHTML = "<p style='color: red; text-align: center;'>A critical error occurred. Please refresh.</p>";
         }
      }
    }

    /**
     * Main initialization. Loads data, sets up menu.
     */
    async function runInit() {
      try {
        allNotesData = await fetch(DATA_URL).then(r => r.json());
        loadHighScores();
        setupMenu();
        addEventListeners();
        showScreen(DOM.menu);
      } catch (error) {
        console.error("Failed to initialize quiz:", error);
        DOM.wrapper.innerHTML = "<p style='color: red; text-align: center;'>Failed to load quiz data. Please refresh the page.</p>";
      }
    }
    
    /**
     * Binds all button clicks.
     */
    function addEventListeners() {
      // Menu screen
      DOM.menu.querySelectorAll('.btn').forEach(b => {
        b.onclick = () => {
          currentType = b.dataset.type;
          showScreen(DOM.permission);
        };
      });
      
      // Permission screen
      DOM.startMicBtn.onclick = startListening;
      DOM.permissionCancelBtn.onclick = goHome;
      
      // Quiz/End screens
      DOM.goBackQuizBtn.onclick = goHome;
      DOM.retryBtn.onclick = () => prepStart(currentType);
      DOM.restartBtn.onclick = goHome;
    }
    
    /**
     * Tries to get microphone access and start the tuner.
     */
    async function startListening() {
      DOM.startMicBtn.disabled = true;
      DOM.startMicBtn.textContent = "Starting...";
      DOM.micError.textContent = "";

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048; // Standard size
        audioBuffer = new Float32Array(analyser.fftSize); // Re-use this buffer
        
        mediaStreamSource = audioContext.createMediaStreamSource(stream);
        mediaStreamSource.connect(analyser);
        
        // Start the quiz
        prepStart(currentType);

      } catch (err) {
        console.error("Microphone access denied:", err);
        DOM.micError.textContent = "Microphone access was denied. Please check your browser settings.";
        DOM.startMicBtn.disabled = false;
        DOM.startMicBtn.textContent = "Start Listening";
      }
    }

    /**
     * Loads high scores from localStorage.
     */
    function loadHighScores() {
      try {
        const stored = localStorage.getItem('intrvl-pitch-highscores');
        highScores = stored ? JSON.parse(stored) : {};
      } catch (e) { highScores = {}; }
    }
    
    /**
     * Saves high scores.
     */
    function saveHighScores() {
      localStorage.setItem('intrvl-pitch-highscores', JSON.stringify(highScores));
    }
    
    /**
     * Updates high score text on the menu.
     */
    function setupMenu() {
      loadHighScores();
      DOM.menu.querySelectorAll('.btn').forEach(b => {
        const type = b.dataset.type;
        const score = highScores[type] || 0;
        const p = b.nextElementSibling; 
        if (p) {
          p.innerHTML = `High Score<br>${score}`;
        }
      });
    }
    
    /**
     * Stops the audio and returns to the main menu.
     */
    function goHome() {
      isListening = false;
      if (rafID) {
        cancelAnimationFrame(rafID);
        rafID = null;
      }
      if (audioContext && audioContext.state !== 'closed') {
        audioContext.close(); 
      }
      if (mediaStreamSource) {
        mediaStreamSource.disconnect();
      }
      
      setupMenu();
      showScreen(DOM.menu);
    }

    /**
     * Sets up the quiz screen.
     */
    function prepStart(type) {
      score = 0;
      currentType = type;
      usedQuestions = new Set();
      quizData = allNotesData.filter(d => typeFilters[type].includes(d.clef));
      
      DOM.quizTitle.textContent = typeNames[type] + " Quiz";
      DOM.scoreDisplay.textContent = `Score: 0`;
      DOM.gameHigh.textContent = `High Score: ${highScores[type] || 0}`;
      DOM.feedback.textContent = "";
      DOM.feedback.className = "";
      
      // Reset button states on permission screen
      DOM.startMicBtn.disabled = false;
      DOM.startMicBtn.textContent = "Start Listening";
      
      showScreen(DOM.quiz);
      nextQ();
      
      // Start the pitch detection loop
      isListening = true;
      updatePitch();
    }
    
    /**
     * The main "tuner" loop. Runs continuously.
     */
    function updatePitch() {
      if (!isListening) return; // Stop the loop if quiz is over

      // Ensure audioContext is still running
      if (!audioContext || audioContext.state === 'closed') {
        console.warn("AudioContext closed, stopping listener.");
        isListening = false;
        return;
      }

      analyser.getFloatTimeDomainData(audioBuffer);
      
      // Use the new autoCorrelate function
      const pitch = autoCorrelate(audioBuffer, audioContext.sampleRate);
      
      if (pitch !== -1) { 
        // Convert frequency (pitch) to a note name
        const noteNum = noteFromPitch(pitch);
        const noteName = noteStrings[noteNum % 12];
        const octave = Math.floor(noteNum / 12) - 1;
        const detectedNote = noteName + octave; // This gives "C4", "G#5" etc.
        
        DOM.tunerStatus.textContent = `Detected: ${pitch.toFixed(1)} Hz`;
        DOM.heardNote.textContent = `Heard: ${detectedNote}`;
        
        // Check for win
        if (detectedNote === currentQuestion['note-name']) {
          handleCorrectAnswer();
        }
      } else {
        DOM.tunerStatus.textContent = "Listening...";
        DOM.heardNote.textContent = "Heard: ---";
      }
      
      // Continue the loop
      rafID = requestAnimationFrame(updatePitch);
    }
    
    /**
     * Gets the next question, or ends the game.
     */
    function nextQ() {
      DOM.feedback.textContent = "";
      DOM.feedback.className = "";
      
      let available = quizData.filter(q => !usedQuestions.has(q.fileurl));
      if (available.length === 0) {
        if (usedQuestions.size > 0) {
            console.log("All questions used, resetting...");
            usedQuestions.clear();
            available = quizData;
        } else {
            console.error("No questions available for this clef type.");
            return endGame();
        }
      }
      
      currentQuestion = available[Math.floor(Math.random() * available.length)];
      usedQuestions.add(currentQuestion.fileurl);
      
      const filename = currentQuestion.fileurl.split('/').pop();
      const clef = currentQuestion.clef;
      DOM.questionImage.src = `${IMAGE_BASE_URL}/${clef}/${filename}`;
      DOM.questionImage.alt = `Note on a ${clef} clef stave`;
    }

    /**
     * Handles a correct answer.
     */
    function handleCorrectAnswer() {
      if (!isListening) return; // Prevent double-scoring
      
      isListening = false; // Pause listening
      cancelAnimationFrame(rafID); // Stop the loop
      rafID = null;

      score++;
      DOM.scoreDisplay.textContent = `Score: ${score}`;
      DOM.feedback.textContent = 'Correct!';
      DOM.feedback.className = 'correct';
      
      // Show next question after a delay
      setTimeout(() => {
        isListening = true; // Resume listening
        nextQ();
        updatePitch(); // Restart the loop
      }, 1500);
    }

    /**
     * Ends the game and shows the end screen.
     */
    function endGame() {
      isListening = false;
      if (rafID) {
        cancelAnimationFrame(rafID);
        rafID = null;
      }
      if (audioContext && audioContext.state !== 'closed') {
        audioContext.close(); // Stop the mic
      }
      if (mediaStreamSource) {
        mediaStreamSource.disconnect();
      }
      
      DOM.endTitle.textContent = `Quiz Complete: ${typeNames[currentType]}`;
      DOM.finalScore.textContent = `Final Score: ${score}`;
      
      let oldHigh = highScores[currentType] || 0;
      if (score > oldHigh) {
        highScores[currentType] = score;
        saveHighScores();
        DOM.finalScore.textContent += ` â€“ ðŸŽ‰ New High Score! ðŸŽ‰`;
      }
      DOM.endHigh.textContent = `High Score: ${highScores[currentType]}`;
      
      showScreen(DOM.end);
    }

    // --- Start ---
    // Use DOMContentLoaded to start the app
    document.addEventListener('DOMContentLoaded', onDomReady);

  </script>
</div>
